<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Report Incident | CICS AlertSOS</title>
<link rel="stylesheet" href="style.css" />
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
  body {
    background-color: #f9fafb;
    overflow-x: hidden;
    margin: 0;
    padding: 0;
  }

  /* Sidebar when opened */
  custom-sidebar.open {
    transform: translateX(0);
  }

  /* Sidebar on desktop */
  @media (min-width: 769px) {
    custom-sidebar {
      transform: translateX(0);
      top: 4rem; /* below navbar */
      height: calc(100% - 4rem);
      box-shadow: none;
    }
  }

  /* =========================
     Overlay for Mobile
  ========================== */
  #overlay {
    display: none;
  }

  #overlay.active {
    display: block;
  }

  /* =========================
     Main Content Layout
  ========================== */
  main {
    transition: margin 0.3s ease;
    position: relative;
    z-index: 1;
  }

  @media (min-width: 769px) {
    main {
      margin-left: 16rem; /* Sidebar width */
      margin-top: 4rem;   /* Navbar height */
      padding: 1.5rem 2rem 2rem 2rem;
    }
  }

  @media (max-width: 768px) {
    main {
      margin: 0;
      margin-top: 4rem; /* Below navbar */
      padding: 1rem;
    }
  }
</style>
</head>

<body>
  <!-- Navbar -->
  <custom-navbar></custom-navbar>

  <!-- Sidebar -->
  <custom-sidebar></custom-sidebar>

  <!-- Overlay for mobile -->
  <div id="overlay" class="fixed inset-0 bg-black bg-opacity-40 z-[900] hidden md:hidden"></div>

  <!-- Main Content -->
  <main>
    <div class="bg-white rounded-xl shadow-md p-6">
      <h1 class="text-2xl font-bold text-gray-800 mb-6">Report an Incident</h1>

      <form id="incidentForm" enctype="multipart/form-data" class="space-y-6">
        <!-- Incident Type -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Incident Type</label>
          <select id="incidentType" name="incidentType"
            class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white focus:ring-red-500 focus:border-red-500"
            required>
            <option value="" disabled selected>Select an incident type</option>
            <option value="Fire">üî• Fire</option>
            <option value="Medical">üè• Medical Emergency</option>
            <option value="Security">üö® Security Issue</option>
            <option value="Natural Disaster">üå™Ô∏è Natural Disaster</option>
            <option value="Other">‚ö†Ô∏è Other</option>
          </select>
        </div>

        <!-- Description -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
          <textarea id="description" name="description" rows="4"
            placeholder="Describe what happened..."
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-red-500 focus:border-red-500"
            required></textarea>
        </div>

        <!-- Upload Media -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Upload Photos or Videos</label>
          <input type="file" id="media" name="media[]" accept="image/*,video/*" multiple
            class="w-full text-gray-700 border border-gray-300 rounded-md p-2 bg-white cursor-pointer">
          <small class="text-gray-500">You can upload multiple photos or videos.</small>
        </div>

        <!-- Location -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Your Location</label>
          <div id="locationDisplay"
            class="p-3 bg-gray-100 border border-gray-300 rounded-md text-gray-700 mb-3">
            Detecting location...
          </div>
          <input type="hidden" id="latitude" name="latitude">
          <input type="hidden" id="longitude" name="longitude">

          <!-- Map -->
          <div id="map" class="w-full h-64 border border-gray-300 rounded-md"></div>
        </div>

        <!-- Submit -->
        <div class="flex justify-end">
          <button type="submit"
            class="bg-red-600 text-white px-6 py-2 rounded-md hover:bg-red-700 transition flex items-center gap-2">
            <i data-feather="send"></i> Submit Report
          </button>
        </div>
      </form>
    </div>
  </main>

  <!-- Components -->
  <script src="components/navbar.js"></script>
  <script src="components/sidebar.js"></script>

  <script>
    feather.replace();

    const overlay = document.getElementById("overlay");
    const sidebar = document.querySelector("custom-sidebar");

    // Listen for sidebar toggle event from navbar
    window.addEventListener("toggle-sidebar", () => {
      sidebar.classList.toggle("open");
      overlay.classList.toggle("hidden");
      overlay.classList.toggle("active");
    });

    // Close sidebar when overlay is clicked
    overlay.addEventListener("click", () => {
      sidebar.classList.remove("open");
      overlay.classList.add("hidden");
    });

    // Map initialization
    let map, marker;

    function initMap(lat, lng) {
      map = L.map('map').setView([lat, lng], 16);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      marker = L.marker([lat, lng]).addTo(map)
        .bindPopup("üìç Your Location")
        .openPopup();
    }

    function updateMarker(lat, lng) {
      marker.setLatLng([lat, lng])
        .update()
        .bindPopup("üìç Your Current Location")
        .openPopup();
      map.setView([lat, lng], map.getZoom());
    }

    window.onload = function() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lon;
            document.getElementById('locationDisplay').innerHTML =
              `üìç Latitude: <b>${lat.toFixed(6)}</b>, Longitude: <b>${lon.toFixed(6)}</b>`;
            initMap(lat, lon);

            navigator.geolocation.watchPosition(
              (pos) => {
                const newLat = pos.coords.latitude;
                const newLon = pos.coords.longitude;
                document.getElementById('latitude').value = newLat;
                document.getElementById('longitude').value = newLon;
                document.getElementById('locationDisplay').innerHTML =
                  `üìç Latitude: <b>${newLat.toFixed(6)}</b>, Longitude: <b>${newLon.toFixed(6)}</b>`;
                updateMarker(newLat, newLon);
              },
              (err) => console.error(err),
              { enableHighAccuracy: true, maximumAge: 1000 }
            );
          },
          () => {
            document.getElementById('locationDisplay').textContent =
              "‚ö†Ô∏è Location access denied. Showing default location.";
            initMap(13.9404, 121.6202);
          },
          { enableHighAccuracy: true }
        );
      } else {
        document.getElementById('locationDisplay').textContent =
          "‚ùå Geolocation not supported by your browser.";
        initMap(13.9404, 121.6202);
      }
    };

    document.getElementById('incidentForm').addEventListener('submit', function(e) {
      e.preventDefault();
      alert('‚úÖ Incident report submitted successfully!');
      this.reset();
    });
  </script>
</body>
</html>
